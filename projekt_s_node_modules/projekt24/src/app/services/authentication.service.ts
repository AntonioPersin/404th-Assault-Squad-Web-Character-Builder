import { Injectable, APP_INITIALIZER } from '@angular/core';
import { HttpClientService } from './http-client.service';
import { Observable, Subject } from 'rxjs';
import { Router } from '@angular/router';

@Injectable({
  providedIn: 'root'
})
export class AuthenticationService {

  private loggedInUser;
  errorMessage:Subject<string>=new Subject<string>();
  private newUser;
  users;

  constructor(private httpClient:HttpClientService, private router:Router) {   }

  onLogin(creds:{username:string, password:string}){
    new Observable(observer=>{
      setTimeout(()=>{
        let tmpUser;
        this.httpClient.getUsers().subscribe(res=>{
          this.users=[...res];
          tmpUser=this.users.find(u=>u.username==creds.username && u.password==creds.password);
          observer.next(tmpUser);
        });
        
      },1000);
    }).subscribe((user:{username:string, password:string, name:string, email:string, status:number})=>{
      console.log(user);
      
      if(user){
        this.loggedInUser=user;
        console.log(this.loggedInUser);
        
        localStorage.setItem('user',JSON.stringify(this.loggedInUser));
        this.router.navigate(['/']);
      }else{
        this.errorMessage.next("Wrong username or password");
      }
    })
  }

  onLogout(){
    this.loggedInUser=null;
    localStorage.removeItem('user');
    this.router.navigate(['/login']);
  }

  onRegister(creds:{username:string, password:string, name:string, email:string, status:number}){
    this.newUser=creds;
    console.log(this.newUser);
    this.httpClient.addUser(this.newUser).subscribe();
    this.router.navigate(['/login']);
  }

}
